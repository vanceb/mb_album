{% extends "base.html" %}

{% block title %}{{ album.Artist }} - {{ album['Album/Release'] }}{% endblock %}

{% block header %}{{ album.Artist }} - {{ album['Album/Release'] }} {% if album['First Release'] %}({{ album['First Release'][:4] if album['First Release']|length >= 4 else album['First Release'] }}){% endif %}{% endblock %}

{% block content %}
<div style="margin-bottom: 1rem;">
    <a href="{{ url_for('catalog') }}"><i class="fas fa-arrow-left"></i> Back to Catalog</a>
</div>

<div style="display: flex; gap: 2rem; align-items: flex-start;">
    <!-- Left Column: Cover Art + Metadata -->
    <div style="flex-shrink: 0; width: 300px;">
        {% set cover_path = 'coverart/' + album.Barcode + '.jpg' %}
        <img src="{{ url_for('static', filename=cover_path) }}" 
             alt="Album cover" 
             style="width: 300px; height: 300px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);"
             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
        <div style="display: none; width: 300px; height: 300px; background-color: #f0f0f0; border: 2px dashed #ccc; border-radius: 8px; align-items: center; justify-content: center; color: #666;">
            No Cover Art
        </div>
        
        <!-- Metadata Dropdown -->
        <div style="margin-top: 1rem;">
            <button onclick="toggleMetadata()" style="background-color: #333; color: white; border: 1px solid #333; padding: 0.75rem 1rem; border-radius: 4px; cursor: pointer; width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                <span><strong>Album Metadata</strong></span>
                <span id="metadata-arrow"><i class="fas fa-chevron-down"></i></span>
            </button>
            <div id="metadata-content" style="display: none; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; padding: 1rem; background-color: white;">
                <table style="width: 100%; font-size: 0.9rem;">
                    <tr>
                        <td style="padding: 0.25rem 0; vertical-align: top;"><strong>First Release:</strong></td>
                        <td style="padding: 0.25rem 0;">{{ album['First Release'] or 'Unknown' }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.25rem 0; vertical-align: top;"><strong>Release Date:</strong></td>
                        <td style="padding: 0.25rem 0;">{{ album['Release Date'] or 'Unknown' }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.25rem 0; vertical-align: top;"><strong>Country:</strong></td>
                        <td style="padding: 0.25rem 0;">{{ album.Country or 'Unknown' }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.25rem 0; vertical-align: top;"><strong>Barcode:</strong></td>
                        <td style="padding: 0.25rem 0;"><code style="font-size: 0.8rem;">{{ album.Barcode or 'No barcode' }}</code></td>
                    </tr>
                    <tr>
                        <td style="padding: 0.25rem 0; vertical-align: top;"><strong>MusicBrainz:</strong></td>
                        <td style="padding: 0.25rem 0;">
                            {% if album['MusicBrainz ID'] %}
                            <a href="https://musicbrainz.org/release/{{ album['MusicBrainz ID'] }}" target="_blank" style="font-size: 0.8rem;">
                                <i class="fas fa-external-link-alt"></i> MusicBrainz
                            </a>
                            {% else %}
                            Unknown
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Right Column: Track Listing -->
    <div style="flex-grow: 1;">
        {% if tracks %}
        <div style="background-color: #f8f9fa; padding: 1rem 1.5rem; border-radius: 4px; max-height: 500px; overflow-y: auto; line-height: 1.4; margin: 0;">
            {% for track in tracks %}
            <div style="margin: 0.5rem 0; display: flex; align-items: center;">
                <span class="star-icon" 
                      onclick="toggleStar('{{ album.Barcode }}', '{{ loop.index }}', this)"
                      style="margin-right: 0.5rem; cursor: pointer; font-size: 1.1rem; color: {% if loop.index|string in starred_tracks %}#ffc107{% else %}#ccc{% endif %};">
                    <i class="{% if loop.index|string in starred_tracks %}fas{% else %}far{% endif %} fa-star"></i>
                </span>
                <span style="margin-right: 0.75rem; font-weight: bold; color: #666; min-width: 2rem;">{{ loop.index }}.</span>
                <span style="flex: 1;">{{ track }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleMetadata() {
    const content = document.getElementById('metadata-content');
    const arrow = document.getElementById('metadata-arrow');
    
    if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        arrow.innerHTML = '<i class="fas fa-chevron-up"></i>';
    } else {
        content.style.display = 'none';
        arrow.innerHTML = '<i class="fas fa-chevron-down"></i>';
    }
}

async function toggleStar(barcode, trackNumber, starElement) {
    const starIcon = starElement.querySelector('i');
    const isStarred = starIcon.classList.contains('fas');
    
    try {
        // Disable clicking during request
        starElement.style.pointerEvents = 'none';
        
        const endpoint = isStarred ? `/unstar/${barcode}/${trackNumber}` : `/star/${barcode}/${trackNumber}`;
        const response = await fetch(endpoint, { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            // Toggle star appearance
            if (isStarred) {
                starIcon.classList.remove('fas');
                starIcon.classList.add('far');
                starElement.style.color = '#ccc';
            } else {
                starIcon.classList.remove('far');
                starIcon.classList.add('fas');
                starElement.style.color = '#ffc107';
            }
        } else {
            alert(`Error: ${data.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error toggling star:', error);
        alert('Error toggling star. Please try again.');
    } finally {
        // Re-enable clicking
        starElement.style.pointerEvents = 'auto';
    }
}
</script>
{% endblock %}